<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Discord Guild Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #2c2f33;
      color: white;
      text-align: center;
      padding: 2rem;
    }
    .btn {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #7289da;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    .guild {
      background: #2f3136;
      margin: 10px auto;
      padding: 10px;
      width: 300px;
      border-radius: 10px;
      display: flex;
      align-items: center;
    }
    .guild img {
      width: 48px;
      height: 48px;
      margin-right: 10px;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<h1>My Discord Servers</h1>
<div id="content">
  <p>Click below to authorize with Discord</p>
  <button class="btn" onclick="login()">Login with Discord</button>
</div>

<script>
  const clientId = '1293659946164158495';
  const clientSecret = 'pCjnhLBpE01W4uJjzQbgteFYx1YamCpV';
  const redirectUri = 'https://danielschijvershof.github.io/Testy/'
  const code = new URLSearchParams(window.location.search).get("code");

  function login() {
    const scope = "identify guilds";
    const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${scope.replace(" ", "%20")}`;
    window.location.href = authUrl;
  }

  async function exchangeCodeForToken(code) {
    const body = new URLSearchParams({
      client_id: clientId,
      client_secret: clientSecret,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: redirectUri,
      scope: 'identify guilds'
    });

    const res = await fetch('https://discord.com/api/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body
    });

    if (!res.ok) {
      document.getElementById("content").innerHTML = "<p>Authorization failed. Try again.</p>";
      return;
    }

    const data = await res.json();
    loadUserGuilds(data.access_token);
  }

  async function loadUserGuilds(token) {
    const [userRes, guildsRes] = await Promise.all([
      fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${token}` }
      }),
      fetch('https://discord.com/api/users/@me/guilds', {
        headers: { Authorization: `Bearer ${token}` }
      })
    ]);

    const user = await userRes.json();
    const guilds = await guildsRes.json();

    let html = `<h2>Welcome, ${user.username}!</h2><h3>Your Servers:</h3>`;
    guilds.forEach(guild => {
      const icon = guild.icon 
        ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`
        : 'https://via.placeholder.com/48';
      html += `<div class="guild"><img src="${icon}" alt=""><span>${guild.name}</span></div>`;
    });
    document.getElementById('content').innerHTML = html;
  }

  if (code) {
    document.getElementById('content').innerHTML = "<p>Authorizing...</p>";
    exchangeCodeForToken(code);
    // Remove ?code=... from URL
    window.history.replaceState({}, document.title, redirectUri);
  }
</script>

</body>
</html>